<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0c" />
  <link rel="manifest" href="manifest.json">
  <title>PWA Clothing Shop</title>
  <style>
    :root{
      --bg:#0b0b0c;
      --card:#131316;
      --muted:#9aa0a6;
      --text:#f2f3f5;
      --accent:#ff3b7a;
      --accent2:#6ae4ff;
      --border:rgba(255,255,255,.08);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --r:18px;
      --max: 980px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
  margin:0;
  font-family:var(--font);

  /* –ª–µ–¥—è–Ω–æ–π —Ñ–æ–Ω, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–µ–º—ã */
  background:
    radial-gradient(900px 700px at 20% 0%, rgba(34,211,238,.10), transparent 55%),
    radial-gradient(900px 700px at 95% 10%, rgba(59,130,246,.10), transparent 55%),
    var(--bg);

  color:var(--text);
  overflow-x:hidden;
}
    a{color:inherit}
    .app{
      max-width:var(--max);
      margin:0 auto;
      padding: calc(10px + var(--safe-top)) 12px calc(80px + var(--safe-bottom)) 12px;
    }

    /* Top bar */
    .topbar{
      position:sticky; top:0;
      padding: calc(10px + var(--safe-top)) 12px 10px 12px;
      background: linear-gradient(to bottom, rgba(11,11,12,.92), rgba(11,11,12,.65), transparent);
      backdrop-filter: blur(14px);
      z-index:10;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .topbar-inner{
      max-width:var(--max);
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:10px;
      padding:0 0 8px 0;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(255,59,122,.95), rgba(106,228,255,.95));
      box-shadow: 0 10px 30px rgba(255,59,122,.12);
      font-weight:900;
      letter-spacing:.5px;
      color:#0b0b0c;
    }
    .brand h1{
      margin:0;
      font-size:14px;
      line-height:1.05;
    }
    .brand small{display:block; color:var(--muted); font-weight:600; margin-top:2px}
    .spacer{flex:1}
    .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      display:flex; align-items:center; gap:8px;
      cursor:pointer;
      transition:.15s ease;
    }
    .pill:hover{transform: translateY(-1px); background: rgba(255,255,255,.05)}
    .pill .dot{
      width:8px;height:8px;border-radius:99px;background:var(--accent);
      box-shadow:0 0 0 6px rgba(255,59,122,.12);
    }

    /* Tabs */
    .tabs{
      display:flex; gap:8px; align-items:center;
      overflow:auto;
      padding:0 0 8px 0;
      scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{display:none}
    .tab{
      white-space:nowrap;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition:.15s ease;
    }
    .tab.active{
      color:var(--text);
      background: rgba(255,255,255,.07);
      border-color: rgba(255,255,255,.14);
    }

    /* Stories */
    .stories{
      display:flex; gap:10px; overflow:auto;
      padding:8px 2px 10px 2px;
      scrollbar-width:none;
    }
    .stories::-webkit-scrollbar{display:none}
    .story{
      width:70px; flex:0 0 auto;
      display:flex; flex-direction:column; align-items:center; gap:6px;
      cursor:pointer;
    }
    .story .ring{
      width:64px;height:64px;border-radius:999px;
      padding:3px;
      background: conic-gradient(from 0deg, var(--accent), var(--accent2), var(--accent));
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .story .avatar{
      width:58px;height:58px;border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(0,0,0,.35);
      display:grid;place-items:center;
      overflow:hidden;
    }
    .story .avatar img{width:100%;height:100%;object-fit:cover}
    .story span{font-size:12px;color:var(--muted);max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    /* Cards & grid */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding: 6px 0 10px 0;
    }
    @media (min-width: 820px){
      .grid{grid-template-columns: 1fr 1fr}
    }
    .card{
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:12px 12px 10px 12px;
      display:flex; align-items:center; gap:10px;
    }
    .pfp{
      width:34px;height:34px;border-radius:12px;
      background: rgba(255,255,255,.09);
      display:grid;place-items:center;
      font-weight:900;
    }
    .meta{display:flex;flex-direction:column;gap:2px}
    .meta b{font-size:13px}
    .meta small{color:var(--muted);font-weight:600}
    .card-body{padding:0 12px 12px 12px}
    .media{
      width:100%;
      border-radius: 14px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.06);
      overflow:hidden;
      margin-bottom:10px;
    }
    .media img{width:100%;height:auto;display:block}
    .media video{width:100%;height:auto;display:block}
    .row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top:10px;
    }
    .btn{
      border:none;
      background: linear-gradient(135deg, rgba(255,59,122,.95), rgba(106,228,255,.95));
      color:#0b0b0c;
      font-weight:900;
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition:.15s ease;
      box-shadow: 0 12px 30px rgba(255,59,122,.10);
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.ghost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      font-weight:800;
      box-shadow:none;
    }
    .btn.small{padding:8px 10px; border-radius:12px; font-weight:900}
    .price{
      font-weight:900;
      display:flex; align-items:baseline; gap:8px;
    }
    .price s{color:var(--muted);font-weight:800;font-size:12px}

    /* Bottom nav */
    .bottom{
      position: fixed; left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + var(--safe-bottom)) 12px;
      background: linear-gradient(to top, rgba(11,11,12,.92), rgba(11,11,12,.55), transparent);
      backdrop-filter: blur(14px);
      z-index:11;
      border-top:1px solid rgba(255,255,255,.06);
    }
    .bottom-inner{
      max-width:var(--max);
      margin:0 auto;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
    }
    .navbtn{
      padding:10px 8px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      cursor:pointer;
      display:flex; flex-direction:column; align-items:center; gap:4px;
      font-weight:800;
      font-size:12px;
      transition:.15s ease;
    }
    .navbtn.active{color:var(--text); background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.14)}
    .badge{
      display:inline-grid; place-items:center;
      min-width:20px;height:20px;padding:0 6px;
      border-radius:999px;
      background: rgba(255,59,122,.18);
      border: 1px solid rgba(255,59,122,.28);
      color: var(--text);
      font-size:12px;
      font-weight:900;
      margin-left:6px;
    }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index:20;
      padding: calc(12px + var(--safe-top)) 12px calc(12px + var(--safe-bottom)) 12px;
    }
    .overlay.show{display:block}
    .modal{
      max-width: var(--max);
      margin: 0 auto;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(19,19,22,.92);
      backdrop-filter: blur(18px);
      box-shadow: 0 25px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-head{
      padding: 12px 12px;
      display:flex; align-items:center; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modal-head b{font-size:14px}
    .modal-body{padding:12px}
    .field{
      display:flex; flex-direction:column; gap:6px;
      margin-bottom:10px;
    }
    .field label{color:var(--muted); font-size:12px; font-weight:700}
    .input, .select, textarea{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      font-weight:700;
      font-family: var(--font);
    }
    textarea{min-height:110px; resize: vertical}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 560px){ .split{grid-template-columns:1fr} }
    .list{
      display:flex; flex-direction:column; gap:10px;
    }
    .item{
      display:flex; gap:10px; align-items:center;
      padding:10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .thumb{
      width:56px;height:56px;border-radius:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .thumb img{width:100%;height:100%;object-fit:cover}
    .item .info{flex:1; display:flex; flex-direction:column; gap:4px}
    .item .info b{font-size:13px}
    .item .info small{color:var(--muted); font-weight:700}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .hint{color:var(--muted); font-size:12px; font-weight:700; line-height:1.35}
    .qr{
      width: 220px; height: 220px;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.10);
      background: repeating-linear-gradient(45deg, rgba(255,255,255,.08) 0 10px, rgba(255,255,255,.02) 10px 20px);
      display:grid;place-items:center;
      margin: 10px auto;
      position:relative;
      overflow:hidden;
    }
    .qr b{
      position:absolute; inset:auto 0 16px 0;
      text-align:center;
      color:rgba(255,255,255,.9);
      text-shadow:0 2px 10px rgba(0,0,0,.5);
      font-size:12px;
      letter-spacing:.3px;
    }
    .toast{
      position:fixed; left:50%; bottom: 90px;
      transform: translateX(-50%);
      background: rgba(19,19,22,.92);
      border: 1px solid rgba(255,255,255,.10);
      padding: 10px 12px;
      border-radius: 999px;
      color: var(--text);
      font-weight: 800;
      font-size: 13px;
      display:none;
      z-index:30;
      box-shadow: var(--shadow);
    }
    .toast.show{display:block}
    .mini{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-weight:800;
      font-size:12px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand" id="brandTap">
        <div class="logo" id="logo">ZM</div>
        <div>
          <h1 id="brandTitle">ZETTA MODE</h1>
          <small id="brandTagline">clothing ‚Ä¢ drops ‚Ä¢ reels</small>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="pill" id="openCart">
        <span class="dot"></span>
        <span>–ö–æ—Ä–∑–∏–Ω–∞ <span class="badge" id="cartCount">0</span></span>
      </div>
    </div>

    <div class="tabs" id="tabs"></div>

    <div id="storiesBlock">
      <div class="stories" id="stories"></div>
    </div>
  </div>

  <div class="app">
    <div id="view"></div>
  </div>

  <div class="bottom">
    <div class="bottom-inner">
      <button class="navbtn active" data-nav="home">üè†<div>–î–æ–º</div></button>
      <button class="navbtn" data-nav="reels">üé¨<div>–†–∏–ª—Å—ã</div></button>
      <button class="navbtn" data-nav="catalog">üß•<div>–¢–æ–≤–∞—Ä—ã</div></button>
      <button class="navbtn" data-nav="profile">üë§<div>–ö–∞–±–∏–Ω–µ—Ç</div></button>
    </div>
  </div>

  <!-- Modals -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modal-head">
        <b id="modalTitle">Modal</b>
        <div class="spacer"></div>
        <button class="btn ghost small" id="closeModal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/** ===============================
 *  Storage + Defaults
 *  =============================== */
const LS_KEY = "pwa_shop_state_v1";

const defaultState = {
  admin: { pin: "2468" },
  config: {
    brandTitle: "ZETTA MODE",
    brandTagline: "clothing ‚Ä¢ drops ‚Ä¢ reels",
    theme: {
  bg: "#F6F9FF",
  card: "#FFFFFF",
  text: "#0B0B0C",
  muted: "#5B6470",
  accent: "#3B82F6",
  accent2: "#22D3EE"
},
    blocks: {
      stories: true,
      feed: true,
      reels: true,
      catalog: true
    },
    homeTabs: ["–í—Å–µ", "–ù–æ–≤–∏–Ω–∫–∏", "–û–±—Ä–∞–∑—ã", "–°–∫–∏–¥–∫–∏"],
    policyText: `–ü–æ–ª–∏—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–¥–µ–º–æ).
–ú—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ (—Ç–µ–ª–µ—Ñ–æ–Ω, –§–ò–û, –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ü–í–ó) —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏.`,
    legalText: `–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–¥–µ–º–æ).
–ò–ü/–û–û–û, —Ä–µ–∫–≤–∏–∑–∏—Ç—ã, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –∞–¥—Ä–µ—Å. –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç.`
  },
  profile: {
    name: "",
    phone: "",
    pvzId: "",
    pvzTitle: ""
  },
  cart: [],
  orders: [],
  pvz: [
    {id:"ozon_001", title:"Ozon –ü–í–ó ‚Äî –¶–µ–Ω—Ç—Ä, —É–ª. –õ–µ–Ω–∏–Ω–∞ 12", city:"–ö–∏–∑–ª—è—Ä", geo:"near"},
    {id:"ozon_002", title:"Ozon –ü–í–ó ‚Äî –°–µ–≤–µ—Ä, –ø—Ä-—Ç –ú–∏—Ä–∞ 8", city:"–ö–∏–∑–ª—è—Ä", geo:"near"},
    {id:"ozon_003", title:"Ozon –ü–í–ó ‚Äî –¢–¶ –ì—Ä–∞–Ω–¥, 1 —ç—Ç–∞–∂", city:"–ö–∏–∑–ª—è—Ä", geo:"far"},
    {id:"ozon_004", title:"Ozon –ü–í–ó ‚Äî —É–ª. –°–æ–≤–µ—Ç—Å–∫–∞—è 44", city:"–ö–∏–∑–ª—è—Ä", geo:"far"},
  ],
  products: [
    {
      id:"p1",
      title:"–•—É–¥–∏ Oversize Black",
      price: 3490,
      oldPrice: 4290,
      media: {type:"img", src:"https://images.unsplash.com/photo-1520975958225-2bff4c1d0a22?auto=format&fit=crop&w=1400&q=80"},
      variants: { sizes:["S","M","L","XL"], colors:["Black","Graphite"] },
      desc:"–ü–ª–æ—Ç–Ω—ã–π —Ö–ª–æ–ø–æ–∫, oversize –ø–æ—Å–∞–¥–∫–∞. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä."
    },
    {
      id:"p2",
      title:"–î–∂–∏–Ω—Å—ã Straight Blue",
      price: 3990,
      oldPrice: 0,
      media: {type:"img", src:"https://images.unsplash.com/photo-1542272604-787c3835535d?auto=format&fit=crop&w=1400&q=80"},
      variants: { sizes:["28","30","32","34"], colors:["Blue"] },
      desc:"–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Ä—è–º–Ω–∞—è –ø–æ—Å–∞–¥–∫–∞. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä."
    },
    {
      id:"p3",
      title:"–ö—É—Ä—Ç–∫–∞ Tech Grey",
      price: 6990,
      oldPrice: 7990,
      media: {type:"img", src:"https://images.unsplash.com/photo-1520975682031-a0a89b3b0b8c?auto=format&fit=crop&w=1400&q=80"},
      variants: { sizes:["M","L","XL"], colors:["Grey","Black"] },
      desc:"–õ—ë–≥–∫–∞—è —Ç–µ—Ö-–∫—É—Ä—Ç–∫–∞. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä."
    }
  ],
  feed: [
    {
      id:"f1",
      type:"product",
      title:"Drop –Ω–µ–¥–µ–ª–∏",
      text:"–•—É–¥–∏ + –¥–∂–∏–Ω—Å—ã –≤ –æ–¥–Ω–æ–º —Å—Ç–∏–ª–µ. –ù–∞–∂–º–∏ ¬´–ö—É–ø–∏—Ç—å¬ª –∏ –≤—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç.",
      media:{type:"img", src:"https://images.unsplash.com/photo-1520975661595-6453be3f7070?auto=format&fit=crop&w=1400&q=80"},
      productId:"p1",
      tag:"–ù–æ–≤–∏–Ω–∫–∏"
    },
    {
      id:"f2",
      type:"look",
      title:"–û–±—Ä–∞–∑ –¥–Ω—è",
      text:"–°–æ–±—Ä–∞–ª–∏ –∫–æ–º–ø–ª–µ–∫—Ç –∏–∑ 2 –ø–æ–∑–∏—Ü–∏–π. –°–æ—Ö—Ä–∞–Ω—è–π –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ (–≤ MVP –±–µ–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ).",
      media:{type:"img", src:"https://images.unsplash.com/photo-1520975911701-1b3f9960f671?auto=format&fit=crop&w=1400&q=80"},
      productId:"p2",
      tag:"–û–±—Ä–∞–∑—ã"
    },
    {
      id:"f3",
      type:"promo",
      title:"–°–∫–∏–¥–∫–∞ -15%",
      text:"–ü—Ä–æ–º–æ-–ø–æ—Å—Ç. –ü–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã.",
      media:{type:"img", src:"https://images.unsplash.com/photo-1520975869011-3c3a1ed2bcf1?auto=format&fit=crop&w=1400&q=80"},
      tag:"–°–∫–∏–¥–∫–∏"
    }
  ],
  stories: [
    {id:"s1", title:"–ù–æ–≤–∏–Ω–∫–∏", media:{type:"img", src:"https://images.unsplash.com/photo-1520975607361-31f6d35d4e3e?auto=format&fit=crop&w=900&q=80"}, cta:{type:"product", targetId:"p1", label:"–°–º–æ—Ç—Ä–µ—Ç—å —Ö—É–¥–∏"}},
    {id:"s2", title:"-15%", media:{type:"img", src:"https://images.unsplash.com/photo-1520975614520-9b6a1f3b21ea?auto=format&fit=crop&w=900&q=80"}, cta:{type:"catalog", targetId:"", label:"–í –∫–∞—Ç–∞–ª–æ–≥"}},
    {id:"s3", title:"–û–±—Ä–∞–∑", media:{type:"img", src:"https://images.unsplash.com/photo-1483985988355-763728e1935b?auto=format&fit=crop&w=900&q=80"}, cta:{type:"product", targetId:"p2", label:"–°–º–æ—Ç—Ä–µ—Ç—å –¥–∂–∏–Ω—Å—ã"}}
  ],
  reels: [
    {id:"r1", title:"Reel 1", media:{type:"video", src:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4"}, productIds:["p1"]},
    {id:"r2", title:"Reel 2", media:{type:"video", src:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm"}, productIds:["p2","p3"]}
  ]
};

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(defaultState);
    const parsed = JSON.parse(raw);
    return deepMerge(structuredClone(defaultState), parsed);
  }catch(e){
    return structuredClone(defaultState);
  }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function deepMerge(base, patch){
  for(const k in patch){
    if(patch[k] && typeof patch[k]==="object" && !Array.isArray(patch[k])){
      base[k] = deepMerge(base[k] || {}, patch[k]);
    }else{
      base[k] = patch[k];
    }
  }
  return base;
}

let state = loadState();

/** ===============================
 *  Theme apply
 *  =============================== */

function hexToRgb(hex){
  const h = (hex||"").replace("#","").trim();
  if(h.length !== 6) return {r:11,g:11,b:12};
  return {
    r: parseInt(h.slice(0,2),16),
    g: parseInt(h.slice(2,4),16),
    b: parseInt(h.slice(4,6),16),
  };
}
function luminance({r,g,b}){
  const a = [r,g,b].map(v=>{
    v/=255;
    return v <= 0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4);
  });
  return 0.2126*a[0] + 0.7152*a[1] + 0.0722*a[2];
}

function applyTheme(){
  const t = state.config.theme;
  const r = document.documentElement.style;

  r.setProperty("--bg", t.bg);
  r.setProperty("--card", t.card || "#FFFFFF");
  r.setProperty("--text", t.text);
  r.setProperty("--muted", t.muted);
  r.setProperty("--accent", t.accent);
  r.setProperty("--accent2", t.accent2 || t.accent);

  // –∞–≤—Ç–æ-–ø–æ–¥–±–æ—Ä –≥—Ä–∞–Ω–∏—Ü/—Ç–µ–Ω–µ–π
  const isLight = luminance(hexToRgb(t.bg)) > 0.6;
  r.setProperty("--border", isLight ? "rgba(0,0,0,.10)" : "rgba(255,255,255,.08)");
  r.setProperty("--shadow", isLight ? "0 12px 40px rgba(0,0,0,.10)" : "0 12px 40px rgba(0,0,0,.35)");

  document.getElementById("brandTitle").textContent = state.config.brandTitle;
  document.getElementById("brandTagline").textContent = state.config.brandTagline;
}

applyTheme();

/** ===============================
 *  UI helpers
 *  =============================== */
const view = document.getElementById("view");
const overlay = document.getElementById("overlay");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
const toastEl = document.getElementById("toast");

function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 1600);
}
function openModal(title, html){
  modalTitle.textContent = title;
  modalBody.innerHTML = html;
  overlay.classList.add("show");
}
function closeModal(){
  overlay.classList.remove("show");
  modalBody.innerHTML = "";
}
document.getElementById("closeModal").onclick = closeModal;
overlay.addEventListener("click", (e)=>{ if(e.target===overlay) closeModal(); });

function money(n){ return new Intl.NumberFormat("ru-RU").format(n) + " ‚ÇΩ"; }
function cartCount(){
  return state.cart.reduce((s,i)=>s+i.qty,0);
}
function updateCartBadge(){
  document.getElementById("cartCount").textContent = cartCount();
}
updateCartBadge();

/** ===============================
 *  Navigation
 *  =============================== */
let currentNav = "home";
let currentTab = "–í—Å–µ";

function setNav(nav){
  currentNav = nav;
  document.querySelectorAll(".navbtn").forEach(b=>{
    b.classList.toggle("active", b.dataset.nav===nav);
  });
  
  // PWA: service worker register
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
  });
}
  renderTabs();
  renderStories();
  renderView();
}

document.querySelectorAll(".navbtn").forEach(b=>{
  b.addEventListener("click", ()=>setNav(b.dataset.nav));
});

/** ===============================
 *  Tabs + Stories render
 *  =============================== */
function renderTabs(){
  const tabs = document.getElementById("tabs");
  tabs.innerHTML = "";
  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±—ã —Ç–æ–ª—å–∫–æ –Ω–∞ home
  if(currentNav!=="home" || !state.config.blocks.feed){
    tabs.style.display = "none";
    return;
  }
  tabs.style.display = "flex";
  state.config.homeTabs.forEach(t=>{
    const el = document.createElement("button");
    el.className = "tab" + (currentTab===t?" active":"");
    el.textContent = t;
    el.onclick = ()=>{ currentTab=t; renderTabs(); renderView(); };
    tabs.appendChild(el);
  });
}

function renderStories(){
  const block = document.getElementById("storiesBlock");
  const wrap = document.getElementById("stories");
  const shouldShow = currentNav==="home" && state.config.blocks.stories;
  block.style.display = shouldShow ? "block" : "none";
  if(!shouldShow) return;
  wrap.innerHTML = "";
  state.stories.forEach(st=>{
    const el = document.createElement("div");
    el.className = "story";
    el.innerHTML = `
      <div class="ring"><div class="avatar">${
        st.media.type==="img" ? `<img src="${st.media.src}" alt="">` : "‚ñ∂"
      }</div></div>
      <span>${escapeHtml(st.title)}</span>
    `;
    el.onclick = ()=>openStoryViewer(st.id);
    wrap.appendChild(el);
  });
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

/** ===============================
 *  Views render
 *  =============================== */
function renderView(){
  if(currentNav==="home") return renderHome();
  if(currentNav==="reels") return renderReels();
  if(currentNav==="catalog") return renderCatalog();
  if(currentNav==="profile") return renderProfile();
}

function renderHome(){
  const blocks = state.config.blocks;
  const items = blocks.feed ? filteredFeed() : [];
  view.innerHTML = `
    ${blocks.feed ? `
      <div class="grid">
        ${items.map(cardFromFeed).join("")}
      </div>
      <div class="hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞: 7 —Ä–∞–∑ –Ω–∞–∂–º–∏ –Ω–∞ –ª–æ–≥–æ—Ç–∏–ø (ZM), —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–∫—Ä—ã—Ç—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä (PIN).</div>
    ` : `<div class="hint">–õ–µ–Ω—Ç–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.</div>`}
  `;
  wireFeedButtons();
}

function filteredFeed(){
  const t = currentTab;
  if(t==="–í—Å–µ") return state.feed;
  return state.feed.filter(p => (p.tag||"")===t);
}

function cardFromFeed(post){
  const tag = post.tag ? `<span class="mini">${escapeHtml(post.tag)}</span>` : "";
  const title = escapeHtml(post.title||"");
  const text = escapeHtml(post.text||"");
  const mediaHtml = post.media ? (
    post.media.type==="img"
      ? `<div class="media"><img src="${post.media.src}" alt=""></div>`
      : `<div class="media"><video src="${post.media.src}" muted playsinline controls></video></div>`
  ) : "";
  const product = post.productId ? state.products.find(p=>p.id===post.productId) : null;

  return `
    <div class="card">
      <div class="card-head">
        <div class="pfp">Z</div>
        <div class="meta">
          <b>${title}</b>
          <small>${tag} <span style="opacity:.6">‚Ä¢</span> ${escapeHtml(state.config.brandTitle)}</small>
        </div>
      </div>
      <div class="card-body">
        ${mediaHtml}
        <div style="font-weight:800; line-height:1.35">${text}</div>
        <div class="row">
          ${product ? `
            <div class="price">
              <span>${money(product.price)}</span>
              ${product.oldPrice ? `<s>${money(product.oldPrice)}</s>` : ``}
            </div>
            <div style="display:flex; gap:8px">
              <button class="btn ghost small" data-open-product="${product.id}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
              <button class="btn small" data-buy-product="${product.id}">–ö—É–ø–∏—Ç—å</button>
            </div>
          ` : `
            <div class="hint">–ü—Ä–æ–º–æ/–∫–æ–Ω—Ç–µ–Ω—Ç</div>
            <button class="btn ghost small" data-open-catalog="1">–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥</button>
          `}
        </div>
      </div>
    </div>
  `;
}

function wireFeedButtons(){
  view.querySelectorAll("[data-open-product]").forEach(b=>{
    b.addEventListener("click", ()=>openProduct(b.dataset.openProduct));
  });
  view.querySelectorAll("[data-buy-product]").forEach(b=>{
    b.addEventListener("click", ()=>openProduct(b.dataset.buyProduct, {autoBuy:true}));
  });
  view.querySelectorAll("[data-open-catalog]").forEach(b=>{
    b.addEventListener("click", ()=>setNav("catalog"));
  });
}

/** ===============================
 *  Catalog
 *  =============================== */
function renderCatalog(){
  if(!state.config.blocks.catalog){
    view.innerHTML = `<div class="hint">–ö–∞—Ç–∞–ª–æ–≥ –æ—Ç–∫–ª—é—á—ë–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.</div>`;
    return;
  }
  view.innerHTML = `
    <div class="grid">
      ${state.products.map(p=>productCard(p)).join("")}
    </div>
  `;
  view.querySelectorAll("[data-open-product]").forEach(b=>{
    b.addEventListener("click", ()=>openProduct(b.dataset.openProduct));
  });
  view.querySelectorAll("[data-buy-product]").forEach(b=>{
    b.addEventListener("click", ()=>openProduct(b.dataset.buyProduct, {autoBuy:true}));
  });
}

function productCard(p){
  return `
    <div class="card">
      <div class="card-body">
        <div class="media">
          ${p.media?.type==="img" ? `<img src="${p.media.src}" alt="">` : `<video src="${p.media?.src||""}" muted playsinline controls></video>`}
        </div>
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
          <div style="font-weight:900">${escapeHtml(p.title)}</div>
          <div class="price">
            <span>${money(p.price)}</span>
            ${p.oldPrice ? `<s>${money(p.oldPrice)}</s>` : ``}
          </div>
        </div>
        <div class="hint" style="margin-top:6px">${escapeHtml(p.desc||"")}</div>
        <div class="row">
          <button class="btn ghost small" data-open-product="${p.id}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
          <button class="btn small" data-buy-product="${p.id}">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>
  `;
}

/** ===============================
 *  Reels
 *  =============================== */
let reelIndex = 0;
function renderReels(){
  if(!state.config.blocks.reels){
    view.innerHTML = `<div class="hint">–†–∏–ª—Å—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.</div>`;
    return;
  }
  const r = state.reels[reelIndex] || state.reels[0];
  if(!r){
    view.innerHTML = `<div class="hint">–ù–µ—Ç —Ä–∏–ª—Å–æ–≤. –î–æ–±–∞–≤—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ.</div>`;
    return;
  }
  view.innerHTML = `
    <div class="card" style="max-width:560px;margin:0 auto;">
      <div class="card-head">
        <div class="pfp">‚ñ∂</div>
        <div class="meta">
          <b>${escapeHtml(r.title||"Reel")}</b>
          <small>–°–≤–∞–π–ø/–∫–æ–ª—ë—Å–∏–∫–æ: —Å–ª–µ–¥—É—é—â–∏–π ‚Ä¢ –¢–æ–≤–∞—Ä—ã –∏–∑ –≤–∏–¥–µ–æ —Å–ø—Ä–∞–≤–∞</small>
        </div>
      </div>
      <div class="card-body">
        <div class="media">
          <video id="reelVideo" src="${r.media.src}" playsinline loop controls></video>
        </div>
        <div class="row">
          <button class="btn ghost small" id="prevReel">‚Üê</button>
          <div style="display:flex;gap:8px">
            <button class="btn ghost small" id="reelProducts">–¢–æ–≤–∞—Ä—ã –∏–∑ –≤–∏–¥–µ–æ</button>
            <button class="btn small" id="nextReel">‚Üí</button>
          </div>
        </div>
        <div class="hint" style="margin-top:10px">Reels –≤ MVP –Ω–∞ –≤–µ–±–µ. –í —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ –º–æ–∂–Ω–æ —É—Å–∏–ª–∏—Ç—å –Ω–∞—Ç–∏–≤–Ω–æ–π –æ–±–æ–ª–æ—á–∫–æ–π APK.</div>
      </div>
    </div>
  `;

  const next = ()=>{ reelIndex = Math.min(state.reels.length-1, reelIndex+1); renderReels(); };
  const prev = ()=>{ reelIndex = Math.max(0, reelIndex-1); renderReels(); };

  document.getElementById("nextReel").onclick = next;
  document.getElementById("prevReel").onclick = prev;

  view.onwheel = (e)=>{ if(Math.abs(e.deltaY)>10){ e.deltaY>0 ? next() : prev(); } };

  document.getElementById("reelProducts").onclick = ()=>{
    const products = (r.productIds||[]).map(id=>state.products.find(p=>p.id===id)).filter(Boolean);
    openModal("–¢–æ–≤–∞—Ä—ã –∏–∑ –≤–∏–¥–µ–æ", `
      <div class="list">
        ${products.map(p=>`
          <div class="item">
            <div class="thumb"><img src="${p.media?.src||""}" alt=""></div>
            <div class="info">
              <b>${escapeHtml(p.title)}</b>
              <small>${money(p.price)}</small>
            </div>
            <button class="btn small" data-buy="${p.id}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        `).join("") || `<div class="hint">–ù–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤.</div>`}
      </div>
    `);
    modalBody.querySelectorAll("[data-buy]").forEach(b=>{
      b.onclick = ()=>{ addToCart(b.dataset.buy, {size:null,color:null}); updateCartBadge(); toast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É"); };
    });
  };

  // autoplay try
  setTimeout(()=>{
    const v = document.getElementById("reelVideo");
    v.muted = true;
    v.play().catch(()=>{});
  }, 50);
}

/** ===============================
 *  Product modal
 *  =============================== */
function openProduct(productId, opts={}){
  const p = state.products.find(x=>x.id===productId);
  if(!p) return;
  const sizes = p.variants?.sizes || [];
  const colors = p.variants?.colors || [];
  openModal("–¢–æ–≤–∞—Ä", `
    <div class="media">
      ${p.media?.type==="img" ? `<img src="${p.media.src}" alt="">` : `<video src="${p.media?.src||""}" muted playsinline controls></video>`}
    </div>
    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px">
      <div>
        <div style="font-size:16px;font-weight:900">${escapeHtml(p.title)}</div>
        <div class="hint" style="margin-top:6px">${escapeHtml(p.desc||"")}</div>
      </div>
      <div class="price">
        <span>${money(p.price)}</span>
        ${p.oldPrice ? `<s>${money(p.oldPrice)}</s>` : ``}
      </div>
    </div>

    <div class="hr"></div>

    <div class="split">
      <div class="field">
        <label>–†–∞–∑–º–µ—Ä</label>
        <select class="select" id="selSize">
          <option value="">–í—ã–±—Ä–∞—Ç—å</option>
          ${sizes.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("")}
        </select>
      </div>
      <div class="field">
        <label>–¶–≤–µ—Ç</label>
        <select class="select" id="selColor">
          <option value="">–í—ã–±—Ä–∞—Ç—å</option>
          ${colors.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("")}
        </select>
      </div>
    </div>

    <div class="row">
      <button class="btn ghost small" id="goCatalog">–ö–∞—Ç–∞–ª–æ–≥</button>
      <button class="btn small" id="addCart">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
    </div>

    <div class="hint" style="margin-top:10px">MVP: –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Ü–µ–Ω—É, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∫–æ—Ä–∑–∏–Ω–µ.</div>
  `);

  modalBody.querySelector("#goCatalog").onclick = ()=>{ closeModal(); setNav("catalog"); };
  modalBody.querySelector("#addCart").onclick = ()=>{
    const size = modalBody.querySelector("#selSize").value || null;
    const color = modalBody.querySelector("#selColor").value || null;
    addToCart(p.id, {size, color});
    updateCartBadge();
    toast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É");
    if(opts.autoBuy){ closeModal(); openCart(); }
  };
}

/** ===============================
 *  Cart + Checkout + SBP demo
 *  =============================== */
document.getElementById("openCart").onclick = ()=>openCart();

function addToCart(productId, variant){
  const key = productId + "|" + (variant.size||"") + "|" + (variant.color||"");
  const existing = state.cart.find(i=>i.key===key);
  if(existing) existing.qty += 1;
  else state.cart.push({ key, productId, variant, qty:1 });
  saveState();
}

function openCart(){
  const items = state.cart.map(i=>{
    const p = state.products.find(x=>x.id===i.productId);
    if(!p) return "";
    const v = [];
    if(i.variant?.size) v.push("–†–∞–∑–º–µ—Ä: " + i.variant.size);
    if(i.variant?.color) v.push("–¶–≤–µ—Ç: " + i.variant.color);
    const vText = v.length ? " ‚Ä¢ " + v.join(", ") : "";
    return `
      <div class="item">
        <div class="thumb">${p.media?.src?`<img src="${p.media.src}" alt="">`:"üß•"}</div>
        <div class="info">
          <b>${escapeHtml(p.title)}</b>
          <small>${money(p.price)}${escapeHtml(vText)}</small>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
          <div class="mini">x${i.qty}</div>
          <div style="display:flex;gap:6px">
            <button class="btn ghost small" data-dec="${escapeHtml(i.key)}">‚àí</button>
            <button class="btn ghost small" data-inc="${escapeHtml(i.key)}">+</button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  const total = calcCartTotal();
  openModal("–ö–æ—Ä–∑–∏–Ω–∞", `
    <div class="list">
      ${items || `<div class="hint">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è.</div>`}
    </div>
    <div class="hr"></div>
    <div class="row">
      <div style="font-weight:900">–ò—Ç–æ–≥–æ: ${money(total)}</div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost small" id="clearCart">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="btn small" id="checkout" ${total<=0?"disabled":""}>–û—Ñ–æ—Ä–º–∏—Ç—å</button>
      </div>
    </div>
    <div class="hint" style="margin-top:10px">–û–ø–ª–∞—Ç–∞: –°–ë–ü (–¥–µ–º–æ). –ü–æ—Å–ª–µ ‚Äú–Ø –æ–ø–ª–∞—Ç–∏–ª‚Äù –∑–∞–∫–∞–∑ —Å—Ç–∞–Ω–µ—Ç PAID.</div>
  `);

  modalBody.querySelectorAll("[data-inc]").forEach(b=>{
    b.onclick = ()=>{ changeQty(b.dataset.inc, +1); openCart(); };
  });
  modalBody.querySelectorAll("[data-dec]").forEach(b=>{
    b.onclick = ()=>{ changeQty(b.dataset.dec, -1); openCart(); };
  });
  modalBody.querySelector("#clearCart").onclick = ()=>{
    state.cart = [];
    saveState();
    updateCartBadge();
    openCart();
  };
  const checkoutBtn = modalBody.querySelector("#checkout");
  if(checkoutBtn) checkoutBtn.onclick = ()=>openCheckout();
}

function changeQty(key, delta){
  const it = state.cart.find(x=>x.key===key);
  if(!it) return;
  it.qty += delta;
  if(it.qty<=0) state.cart = state.cart.filter(x=>x.key!==key);
  saveState();
  updateCartBadge();
}

function calcCartTotal(){
  let sum = 0;
  for(const i of state.cart){
    const p = state.products.find(x=>x.id===i.productId);
    if(p) sum += p.price * i.qty;
  }
  return sum;
}

function openCheckout(){
  // simple validate
  openModal("–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ", `
    <div class="split">
      <div class="field">
        <label>–§–ò–û</label>
        <input class="input" id="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–∏–±–µ–∫" value="${escapeHtml(state.profile.name)}">
      </div>
      <div class="field">
        <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input class="input" id="phone" placeholder="+7..." value="${escapeHtml(state.profile.phone)}">
      </div>
    </div>

    <div class="field">
      <label>–ü–í–ó Ozon</label>
      <div style="display:flex; gap:8px">
        <input class="input" id="pvzSearch" placeholder="–ü–æ–∏—Å–∫ –ü–í–ó (—É–ª–∏—Ü–∞/—Ü–µ–Ω—Ç—Ä/—Ç—Ü)" />
        <button class="btn ghost small" id="near">–†—è–¥–æ–º</button>
      </div>
      <div class="hint" style="margin-top:6px">–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–∏–∂–∞–π—à–∏–π –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏. (–í MVP ‚Äî –¥–µ–º–æ-—Å–ø–∏—Å–æ–∫)</div>
    </div>

    <div class="list" id="pvzList"></div>

    <div class="hr"></div>

    <div class="row">
      <div>
        <div class="hint">–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ</div>
        <div style="font-weight:900;font-size:18px">${money(calcCartTotal())}</div>
      </div>
      <button class="btn small" id="paySbp">–û–ø–ª–∞—Ç–∏—Ç—å –°–ë–ü</button>
    </div>

    <div class="hint" style="margin-top:10px">–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑ –ø–æ—è–≤–∏—Ç—Å—è –≤ ‚Äú–ö–∞–±–∏–Ω–µ—Ç ‚Üí –ó–∞–∫–∞–∑—ã‚Äù.</div>
  `);

  const list = modalBody.querySelector("#pvzList");
  const search = modalBody.querySelector("#pvzSearch");
  const nearBtn = modalBody.querySelector("#near");
  let mode = "all";

  function renderPvz(){
    const q = (search.value||"").toLowerCase();
    const items = state.pvz.filter(x=>{
      const okQ = !q || x.title.toLowerCase().includes(q) || (x.city||"").toLowerCase().includes(q);
      const okM = mode==="all" ? true : x.geo==="near";
      return okQ && okM;
    });
    list.innerHTML = items.map(x=>`
      <div class="item" style="cursor:pointer" data-pvz="${escapeHtml(x.id)}">
        <div class="thumb">üì¶</div>
        <div class="info">
          <b>${escapeHtml(x.title)}</b>
          <small>${escapeHtml(x.city||"")}</small>
        </div>
        <div class="mini">${state.profile.pvzId===x.id ? "–í—ã–±—Ä–∞–Ω" : "–í—ã–±—Ä–∞—Ç—å"}</div>
      </div>
    `).join("") || `<div class="hint">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>`;

    list.querySelectorAll("[data-pvz]").forEach(el=>{
      el.onclick = ()=>{
        const id = el.dataset.pvz;
        const pvz = state.pvz.find(p=>p.id===id);
        state.profile.pvzId = pvz.id;
        state.profile.pvzTitle = pvz.title;
        saveState();
        toast("–ü–í–ó –≤—ã–±—Ä–∞–Ω");
        renderPvz();
      };
    });
  }

  search.oninput = renderPvz;
  nearBtn.onclick = ()=>{ mode = (mode==="all" ? "near" : "all"); nearBtn.textContent = mode==="near" ? "–í—Å–µ" : "–†—è–¥–æ–º"; renderPvz(); };
  renderPvz();

  modalBody.querySelector("#paySbp").onclick = ()=>{
    state.profile.name = modalBody.querySelector("#name").value.trim();
    state.profile.phone = modalBody.querySelector("#phone").value.trim();
    if(!state.profile.name || !state.profile.phone){
      toast("–ó–∞–ø–æ–ª–Ω–∏ –§–ò–û –∏ —Ç–µ–ª–µ—Ñ–æ–Ω");
      return;
    }
    if(!state.profile.pvzId){
      toast("–í—ã–±–µ—Ä–∏ –ü–í–ó Ozon");
      return;
    }
    saveState();
    createOrderAndPay();
  };
}

function createOrderAndPay(){
  const orderId = "ord_" + Math.random().toString(16).slice(2,10);
  const total = calcCartTotal();
  const items = state.cart.map(i=>({ ...i }));
  const order = {
    id: orderId,
    status: "PENDING_PAYMENT",
    createdAt: new Date().toISOString(),
    total,
    items,
    profile: { ...state.profile }
  };
  state.orders.unshift(order);
  saveState();

  openModal("–°–ë–ü –æ–ø–ª–∞—Ç–∞ (–¥–µ–º–æ)", `
    <div class="hint">–ü–æ–∫–∞–∂–∏ QR –≤ –±–∞–Ω–∫–µ –∏–ª–∏ –Ω–∞–∂–º–∏ ‚Äú–û—Ç–∫—Ä—ã—Ç—å –±–∞–Ω–∫‚Äù (–¥–µ–º–æ). –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏ ‚Äú–Ø –æ–ø–ª–∞—Ç–∏–ª‚Äù.</div>
    <div class="qr">
      <div style="font-weight:900; font-size:14px">SBP ‚Ä¢ QR</div>
      <b>–ó–∞–∫–∞–∑ ${escapeHtml(orderId)} ‚Ä¢ ${money(total)}</b>
    </div>
    <div class="row">
      <button class="btn ghost small" id="openBank">–û—Ç–∫—Ä—ã—Ç—å –±–∞–Ω–∫</button>
      <button class="btn small" id="paid">–Ø –æ–ø–ª–∞—Ç–∏–ª</button>
    </div>
    <div class="hint" style="margin-top:10px">–í —Ä–µ–∞–ª–µ –≤–º–µ—Å—Ç–æ –∫–Ω–æ–ø–∫–∏ –±—É–¥–µ—Ç webhook –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –°–ë–ü.</div>
  `);

  modalBody.querySelector("#openBank").onclick = ()=>toast("–î–µ–º–æ: –∑–¥–µ—Å—å –±—É–¥–µ—Ç deeplink –±–∞–Ω–∫–∞");
  modalBody.querySelector("#paid").onclick = ()=>{
    // mark paid
    const o = state.orders.find(x=>x.id===orderId);
    if(o) o.status = "PAID";
    // clear cart
    state.cart = [];
    saveState();
    updateCartBadge();
    toast("–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞");
    closeModal();
    setNav("profile");
  };
}

/** ===============================
 *  Profile + Orders + Policy/Legal
 *  =============================== */
function renderProfile(){
  const p = state.profile;
  const orders = state.orders;
  view.innerHTML = `
    <div class="card">
      <div class="card-head">
        <div class="pfp">üë§</div>
        <div class="meta">
          <b>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç (–¥–æ—Å—Ç–∞–≤–∫–∞)</b>
          <small>–ú–∏–Ω–∏–º—É–º —Ñ—É–Ω–∫—Ü–∏–π: –ü–í–ó, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –∑–∞–∫–∞–∑—ã</small>
        </div>
      </div>
      <div class="card-body">
        <div class="split">
          <div class="field">
            <label>–§–ò–û</label>
            <input class="input" id="pName" value="${escapeHtml(p.name)}" placeholder="–í–∞—à–µ –∏–º—è" />
          </div>
          <div class="field">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input class="input" id="pPhone" value="${escapeHtml(p.phone)}" placeholder="+7..." />
          </div>
        </div>

        <div class="field">
          <label>–ü–í–ó Ozon</label>
          <input class="input" id="pPvz" value="${escapeHtml(p.pvzTitle)}" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –≤ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∏–ª–∏ –Ω–∏–∂–µ" readonly />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn ghost small" id="choosePvz">–í—ã–±—Ä–∞—Ç—å –ü–í–ó</button>
            <button class="btn small" id="saveProfile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>

        <div class="hr"></div>

        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
          <div style="font-weight:900">–ó–∞–∫–∞–∑—ã</div>
          <div class="mini">${orders.length} —à—Ç.</div>
        </div>

        <div class="list" style="margin-top:10px">
          ${orders.map(o=>`
            <div class="item">
              <div class="thumb">üßæ</div>
              <div class="info">
                <b>${escapeHtml(o.id)} ‚Ä¢ ${money(o.total)}</b>
                <small>${new Date(o.createdAt).toLocaleString("ru-RU")} ‚Ä¢ ${escapeHtml(o.status)}</small>
              </div>
              <button class="btn ghost small" data-ord="${escapeHtml(o.id)}">–û—Ç–∫—Ä—ã—Ç—å</button>
            </div>
          `).join("") || `<div class="hint">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>`}
        </div>

        <div class="hr"></div>

        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn ghost small" id="policy">–ü–æ–ª–∏—Ç–∏–∫–∞ –ü–î–Ω</button>
          <button class="btn ghost small" id="legal">–Æ—Ä. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</button>
        </div>
      </div>
    </div>
  `;

  document.getElementById("saveProfile").onclick = ()=>{
    state.profile.name = document.getElementById("pName").value.trim();
    state.profile.phone = document.getElementById("pPhone").value.trim();
    saveState();
    toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
  };
  document.getElementById("choosePvz").onclick = ()=>{ openCheckout(); }; // reuse PVZ chooser inside checkout screen
  document.getElementById("policy").onclick = ()=>openModal("–ü–æ–ª–∏—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö", `<div class="hint" style="white-space:pre-wrap">${escapeHtml(state.config.policyText)}</div>`);
  document.getElementById("legal").onclick = ()=>openModal("–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", `<div class="hint" style="white-space:pre-wrap">${escapeHtml(state.config.legalText)}</div>`);

  view.querySelectorAll("[data-ord]").forEach(b=>{
    b.onclick = ()=>openOrder(b.dataset.ord);
  });
}

function openOrder(id){
  const o = state.orders.find(x=>x.id===id);
  if(!o) return;
  const items = o.items.map(i=>{
    const p = state.products.find(x=>x.id===i.productId);
    const v = [];
    if(i.variant?.size) v.push("–†–∞–∑–º–µ—Ä: " + i.variant.size);
    if(i.variant?.color) v.push("–¶–≤–µ—Ç: " + i.variant.color);
    return `
      <div class="item">
        <div class="thumb">${p?.media?.src?`<img src="${p.media.src}" alt="">`:"üß•"}</div>
        <div class="info">
          <b>${escapeHtml(p?.title||"–¢–æ–≤–∞—Ä")}</b>
          <small>x${i.qty} ‚Ä¢ ${money((p?.price||0)*i.qty)} ${v.length?(" ‚Ä¢ "+escapeHtml(v.join(", "))):""}</small>
        </div>
      </div>
    `;
  }).join("");
  openModal("–ó–∞–∫–∞–∑ " + id, `
    <div class="hint">–°—Ç–∞—Ç—É—Å: <b>${escapeHtml(o.status)}</b></div>
    <div class="hint" style="margin-top:6px">–ü–í–ó: ${escapeHtml(o.profile.pvzTitle||"-")}</div>
    <div class="hr"></div>
    <div class="list">${items}</div>
    <div class="hr"></div>
    <div class="row">
      <div style="font-weight:900">–ò—Ç–æ–≥–æ: ${money(o.total)}</div>
      <button class="btn ghost small" id="close">–û–∫</button>
    </div>
  `);
  modalBody.querySelector("#close").onclick = closeModal;
}

/** ===============================
 *  Hidden Admin (7 taps on logo)
 *  =============================== */
let taps = [];
document.getElementById("brandTap").addEventListener("click", ()=>{
  const now = Date.now();
  taps = taps.filter(t => now - t < 2500);
  taps.push(now);
  if(taps.length >= 7){
    taps = [];
    openAdminPin();
  }
});

function openAdminPin(){
  openModal("–í—Ö–æ–¥ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä", `
    <div class="hint">–°–∫—Ä—ã—Ç–∞—è –∞–¥–º–∏–Ω–∫–∞. –í–≤–µ–¥–∏—Ç–µ PIN.</div>
    <div class="field" style="margin-top:10px">
      <label>PIN</label>
      <input class="input" id="pin" type="password" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    </div>
    <div class="row">
      <button class="btn ghost small" id="cancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn small" id="enter">–í–æ–π—Ç–∏</button>
    </div>
    <div class="hint" style="margin-top:10px">–î–µ–º–æ PIN: ${escapeHtml(state.admin.pin)}</div>
  `);
  modalBody.querySelector("#cancel").onclick = closeModal;
  modalBody.querySelector("#enter").onclick = ()=>{
    const pin = modalBody.querySelector("#pin").value.trim();
    if(pin !== state.admin.pin){
      toast("–ù–µ–≤–µ—Ä–Ω—ã–π PIN");
      return;
    }
    openEditor();
  };
}

/** ===============================
 *  Editor (Power Editor MVP)
 *  =============================== */
function openEditor(){
  openModal("–†–µ–¥–∞–∫—Ç–æ—Ä —Å–∞–π—Ç–∞ (MVP)", `
    <div class="tabs" id="editorTabs" style="margin-bottom:8px">
      ${["–í–∏—Ç—Ä–∏–Ω–∞","–ö–æ–Ω—Ç–µ–Ω—Ç","–¢–æ–≤–∞—Ä—ã","–°—Ç—Ä–∞–Ω–∏—Ü—ã","–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å"].map((t,i)=>
        `<button class="tab ${i===0?"active":""}" data-etab="${t}">${t}</button>`
      ).join("")}
    </div>
    <div id="editorView"></div>
    <div class="hr"></div>
    <div class="row">
      <button class="btn ghost small" id="reset">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
      <button class="btn small" id="publish">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </div>
    <div class="hint" style="margin-top:10px">
      –í—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ LocalStorage (–¥–µ–º–æ). –ù–∞ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —ç—Ç–æ –±—É–¥–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: —á–µ—Ä–Ω–æ–≤–∏–∫ ‚Üí –ø—É–±–ª–∏–∫–∞—Ü–∏—è ‚Üí –≤–µ—Ä—Å–∏–∏.
    </div>
  `);

  const editorView = modalBody.querySelector("#editorView");
  let tab = "–í–∏—Ç—Ä–∏–Ω–∞";

  function setTab(t){
    tab = t;
    modalBody.querySelectorAll("[data-etab]").forEach(b=>b.classList.toggle("active", b.dataset.etab===t));
    renderEditor();
  }

  modalBody.querySelectorAll("[data-etab]").forEach(b=>b.onclick = ()=>setTab(b.dataset.etab));

  function renderEditor(){
    if(tab==="–í–∏—Ç—Ä–∏–Ω–∞") editorView.innerHTML = editorStorefront();
    if(tab==="–ö–æ–Ω—Ç–µ–Ω—Ç") editorView.innerHTML = editorContent();
    if(tab==="–¢–æ–≤–∞—Ä—ã") editorView.innerHTML = editorProducts();
    if(tab==="–°—Ç—Ä–∞–Ω–∏—Ü—ã") editorView.innerHTML = editorPages();
    if(tab==="–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å") editorView.innerHTML = editorSecurity();
    wireEditor();
  }

  function editorStorefront(){
    const c = state.config;
    const t = c.theme;
    return `
      <div class="split">
        <div class="field">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞</label>
          <input class="input" id="eBrandTitle" value="${escapeHtml(c.brandTitle)}" />
        </div>
        <div class="field">
          <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
          <input class="input" id="eBrandTagline" value="${escapeHtml(c.brandTagline)}" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="hint" style="margin-bottom:8px">–¢–µ–º–∞ (—Ü–≤–µ—Ç–∞)</div>
      <div class="split">
        ${colorField("–§–æ–Ω","eBg",t.bg)}
        ${colorField("–¢–µ–∫—Å—Ç","eText",t.text)}
        ${colorField("Muted","eMuted",t.muted)}
        ${colorField("Accent","eAccent",t.accent)}
      </div>

      <div class="hr"></div>

      <div class="hint" style="margin-bottom:8px">–ë–ª–æ–∫–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π</div>
      <div class="split">
        ${toggleField("Stories","eStories",c.blocks.stories)}
        ${toggleField("–õ–µ–Ω—Ç–∞ (Feed)","eFeed",c.blocks.feed)}
        ${toggleField("Reels","eReels",c.blocks.reels)}
        ${toggleField("–ö–∞—Ç–∞–ª–æ–≥","eCatalog",c.blocks.catalog)}
      </div>

      <div class="hr"></div>
      <div class="hint" style="margin-bottom:8px">–¢–∞–±—ã –ª–µ–Ω—Ç—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</div>
      <input class="input" id="eTabs" value="${escapeHtml(c.homeTabs.join(", "))}" />
    `;
  }

  function editorContent(){
    return `
      <div class="hint">Stories</div>
      <div class="list" style="margin-top:8px">
        ${state.stories.map(s=>`
          <div class="item">
            <div class="thumb">${s.media?.src?`<img src="${s.media.src}" alt="">`:"üì∏"}</div>
            <div class="info">
              <b>${escapeHtml(s.title)}</b>
              <small>CTA: ${escapeHtml(s.cta?.label||"-")}</small>
            </div>
            <button class="btn ghost small" data-edit-story="${escapeHtml(s.id)}">–†–µ–¥.</button>
            <button class="btn ghost small" data-del-story="${escapeHtml(s.id)}">–£–¥–∞–ª.</button>
          </div>
        `).join("")}
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn ghost small" id="addStory">+ Story</button>
        <input type="file" id="uploadStory" accept="image/*" style="display:none"/>
      </div>

      <div class="hr"></div>

      <div class="hint">Feed</div>
      <div class="list" style="margin-top:8px">
        ${state.feed.map(f=>`
          <div class="item">
            <div class="thumb">${f.media?.src?`<img src="${f.media.src}" alt="">`:"üì∞"}</div>
            <div class="info">
              <b>${escapeHtml(f.title)}</b>
              <small>${escapeHtml(f.tag||"")}</small>
            </div>
            <button class="btn ghost small" data-edit-feed="${escapeHtml(f.id)}">–†–µ–¥.</button>
            <button class="btn ghost small" data-del-feed="${escapeHtml(f.id)}">–£–¥–∞–ª.</button>
          </div>
        `).join("")}
      </div>
      <button class="btn ghost small" id="addFeed" style="margin-top:10px">+ Post</button>

      <div class="hr"></div>

      <div class="hint">Reels</div>
      <div class="list" style="margin-top:8px">
        ${state.reels.map(r=>`
          <div class="item">
            <div class="thumb">üé¨</div>
            <div class="info">
              <b>${escapeHtml(r.title)}</b>
              <small>${(r.productIds||[]).length} —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏–≤—è–∑–∞–Ω–æ</small>
            </div>
            <button class="btn ghost small" data-edit-reel="${escapeHtml(r.id)}">–†–µ–¥.</button>
            <button class="btn ghost small" data-del-reel="${escapeHtml(r.id)}">–£–¥–∞–ª.</button>
          </div>
        `).join("")}
      </div>
      <button class="btn ghost small" id="addReel" style="margin-top:10px">+ Reel</button>
    `;
  }

  function editorProducts(){
    return `
      <div class="hint">–¢–æ–≤–∞—Ä—ã</div>
      <div class="list" style="margin-top:8px">
        ${state.products.map(p=>`
          <div class="item">
            <div class="thumb">${p.media?.src?`<img src="${p.media.src}" alt="">`:"üß•"}</div>
            <div class="info">
              <b>${escapeHtml(p.title)}</b>
              <small>${money(p.price)}</small>
            </div>
            <button class="btn ghost small" data-edit-prod="${escapeHtml(p.id)}">–†–µ–¥.</button>
            <button class="btn ghost small" data-del-prod="${escapeHtml(p.id)}">–£–¥–∞–ª.</button>
          </div>
        `).join("")}
      </div>
      <button class="btn ghost small" id="addProd" style="margin-top:10px">+ –¢–æ–≤–∞—Ä</button>
      <div class="hint" style="margin-top:10px">–ú–µ–¥–∏–∞ –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å—Å—ã–ª–∫–æ–π –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–æ–π (–¥–ª—è –¥–µ–º–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è base64 ‚Äî –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ —Å —Ä–∞–∑–º–µ—Ä–æ–º).</div>
    `;
  }

  function editorPages(){
    return `
      <div class="field">
        <label>–ü–æ–ª–∏—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö</label>
        <textarea id="ePolicy">${escapeHtml(state.config.policyText)}</textarea>
      </div>
      <div class="field">
        <label>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
        <textarea id="eLegal">${escapeHtml(state.config.legalText)}</textarea>
      </div>
    `;
  }

  function editorSecurity(){
    return `
      <div class="field">
        <label>PIN –∞–¥–º–∏–Ω–∞</label>
        <input class="input" id="ePin" value="${escapeHtml(state.admin.pin)}" inputmode="numeric" />
      </div>
      <div class="hint">–°–∫—Ä—ã—Ç—ã–π –≤—Ö–æ–¥: 7 —Ç–∞–ø–æ–≤ –ø–æ –ª–æ–≥–æ—Ç–∏–ø—É ZM.</div>
    `;
  }

  function colorField(label, id, val){
    return `
      <div class="field">
        <label>${label}</label>
        <div style="display:flex; gap:8px; align-items:center">
          <input class="input" id="${id}" value="${escapeHtml(val)}" />
          <div style="width:42px;height:42px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:${escapeHtml(val)}"></div>
        </div>
      </div>
    `;
  }
  function toggleField(label, id, checked){
    return `
      <div class="field">
        <label>${label}</label>
        <select class="select" id="${id}">
          <option value="true" ${checked?"selected":""}>–í–∫–ª—é—á–µ–Ω–æ</option>
          <option value="false" ${!checked?"selected":""}>–í—ã–∫–ª—é—á–µ–Ω–æ</option>
        </select>
      </div>
    `;
  }

  function wireEditor(){
    // Content actions
    const addStoryBtn = modalBody.querySelector("#addStory");
    if(addStoryBtn){
      addStoryBtn.onclick = ()=>{
        openModal("–î–æ–±–∞–≤–∏—Ç—å Story", storyForm());
        wireStoryForm(null);
      };
    }
    modalBody.querySelectorAll("[data-edit-story]").forEach(b=>{
      b.onclick = ()=>{
        const s = state.stories.find(x=>x.id===b.dataset.editStory);
        openModal("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å Story", storyForm(s));
        wireStoryForm(s?.id || null);
      };
    });
    modalBody.querySelectorAll("[data-del-story]").forEach(b=>{
      b.onclick = ()=>{
        state.stories = state.stories.filter(x=>x.id!==b.dataset.delStory);
        saveState(); toast("–£–¥–∞–ª–µ–Ω–æ"); openEditor();
      };
    });

    const addFeedBtn = modalBody.querySelector("#addFeed");
    if(addFeedBtn){
      addFeedBtn.onclick = ()=>{
        openModal("–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç", feedForm());
        wireFeedForm(null);
      };
    }
    modalBody.querySelectorAll("[data-edit-feed]").forEach(b=>{
      b.onclick = ()=>{
        const f = state.feed.find(x=>x.id===b.dataset.editFeed);
        openModal("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç", feedForm(f));
        wireFeedForm(f?.id || null);
      };
    });
    modalBody.querySelectorAll("[data-del-feed]").forEach(b=>{
      b.onclick = ()=>{
        state.feed = state.feed.filter(x=>x.id!==b.dataset.delFeed);
        saveState(); toast("–£–¥–∞–ª–µ–Ω–æ"); openEditor();
      };
    });

    const addReelBtn = modalBody.querySelector("#addReel");
    if(addReelBtn){
      addReelBtn.onclick = ()=>{
        openModal("–î–æ–±–∞–≤–∏—Ç—å Reel", reelForm());
        wireReelForm(null);
      };
    }
    modalBody.querySelectorAll("[data-edit-reel]").forEach(b=>{
      b.onclick = ()=>{
        const r = state.reels.find(x=>x.id===b.dataset.editReel);
        openModal("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å Reel", reelForm(r));
        wireReelForm(r?.id || null);
      };
    });
    modalBody.querySelectorAll("[data-del-reel]").forEach(b=>{
      b.onclick = ()=>{
        state.reels = state.reels.filter(x=>x.id!==b.dataset.delReel);
        if(reelIndex>=state.reels.length) reelIndex = Math.max(0, state.reels.length-1);
        saveState(); toast("–£–¥–∞–ª–µ–Ω–æ"); openEditor();
      };
    });

    const addProdBtn = modalBody.querySelector("#addProd");
    if(addProdBtn){
      addProdBtn.onclick = ()=>{
        openModal("–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä", productForm());
        wireProductForm(null);
      };
    }
    modalBody.querySelectorAll("[data-edit-prod]").forEach(b=>{
      b.onclick = ()=>{
        const p = state.products.find(x=>x.id===b.dataset.editProd);
        openModal("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä", productForm(p));
        wireProductForm(p?.id || null);
      };
    });
    modalBody.querySelectorAll("[data-del-prod]").forEach(b=>{
      b.onclick = ()=>{
        state.products = state.products.filter(x=>x.id!==b.dataset.delProd);
        // —á–∏—Å—Ç–∏–º —Å—Å—ã–ª–∫–∏
        state.feed.forEach(f=>{ if(f.productId===b.dataset.delProd) f.productId=""; });
        state.reels.forEach(r=>{ r.productIds = (r.productIds||[]).filter(id=>id!==b.dataset.delProd); });
        saveState(); toast("–£–¥–∞–ª–µ–Ω–æ"); openEditor();
      };
    });
  }

  function storyForm(s){
    const ctaType = s?.cta?.type || "catalog";
    return `
      <div class="field"><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input class="input" id="stTitle" value="${escapeHtml(s?.title||"")}" /></div>
      <div class="field"><label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL) –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞</label>
        <input class="input" id="stMedia" value="${escapeHtml(s?.media?.src||"")}" placeholder="https://..." />
        <input type="file" id="stFile" accept="image/*" />
        <div class="hint">–ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏—à—å —Ñ–∞–π–ª ‚Äî –æ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ LocalStorage –∫–∞–∫ base64 (–¥–µ–º–æ).</div>
      </div>
      <div class="split">
        <div class="field"><label>CTA —Ç–∏–ø</label>
          <select class="select" id="stCtaType">
            <option value="catalog" ${ctaType==="catalog"?"selected":""}>–ö–∞—Ç–∞–ª–æ–≥</option>
            <option value="product" ${ctaType==="product"?"selected":""}>–¢–æ–≤–∞—Ä</option>
          </select>
        </div>
        <div class="field"><label>CTA —Ç–µ–∫—Å—Ç</label><input class="input" id="stCtaLabel" value="${escapeHtml(s?.cta?.label||"")}" placeholder="–ù–∞–ø—Ä: –°–º–æ—Ç—Ä–µ—Ç—å" /></div>
      </div>
      <div class="field"><label>CTA target (id —Ç–æ–≤–∞—Ä–∞ –µ—Å–ª–∏ product)</label><input class="input" id="stCtaTarget" value="${escapeHtml(s?.cta?.targetId||"")}" placeholder="p1" /></div>
      <div class="row">
        <button class="btn ghost small" id="cancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn small" id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    `;
  }

  function feedForm(f){
    const type = f?.type || "product";
    return `
      <div class="split">
        <div class="field"><label>–¢–∏–ø</label>
          <select class="select" id="fdType">
            <option value="product" ${type==="product"?"selected":""}>Product</option>
            <option value="look" ${type==="look"?"selected":""}>Look</option>
            <option value="promo" ${type==="promo"?"selected":""}>Promo</option>
          </select>
        </div>
        <div class="field"><label>–¢–µ–≥ (—Ç–∞–±)</label><input class="input" id="fdTag" value="${escapeHtml(f?.tag||"")}" placeholder="–ù–æ–≤–∏–Ω–∫–∏" /></div>
      </div>
      <div class="field"><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input class="input" id="fdTitle" value="${escapeHtml(f?.title||"")}" /></div>
      <div class="field"><label>–¢–µ–∫—Å—Ç</label><input class="input" id="fdText" value="${escapeHtml(f?.text||"")}" /></div>
      <div class="field"><label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL)</label><input class="input" id="fdMedia" value="${escapeHtml(f?.media?.src||"")}" placeholder="https://..." /></div>
      <div class="field"><label>productId (–µ—Å–ª–∏ —Ç–∏–ø product/look)</label><input class="input" id="fdProd" value="${escapeHtml(f?.productId||"")}" placeholder="p1" /></div>
      <div class="row">
        <button class="btn ghost small" id="cancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn small" id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <div class="hint" style="margin-top:10px">–ü–æ–¥—Å–∫–∞–∑–∫–∞: productId –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Ç–æ–≤–∞—Ä–∞—Ö.</div>
    `;
  }

  function reelForm(r){
    const ids = (r?.productIds||[]).join(", ");
    return `
      <div class="field"><label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label><input class="input" id="rlTitle" value="${escapeHtml(r?.title||"")}" /></div>
      <div class="field"><label>–í–∏–¥–µ–æ URL (mp4/webm)</label><input class="input" id="rlMedia" value="${escapeHtml(r?.media?.src||"")}" placeholder="https://..." /></div>
      <div class="field"><label>–ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã (id —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input class="input" id="rlProdIds" value="${escapeHtml(ids)}" placeholder="p1, p2" /></div>
      <div class="row">
        <button class="btn ghost small" id="cancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn small" id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    `;
  }

  function productForm(p){
    const sizes = (p?.variants?.sizes||[]).join(", ");
    const colors = (p?.variants?.colors||[]).join(", ");
    return `
      <div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input class="input" id="prTitle" value="${escapeHtml(p?.title||"")}" /></div>
      <div class="split">
        <div class="field"><label>–¶–µ–Ω–∞</label><input class="input" id="prPrice" value="${escapeHtml(p?.price||"")}" inputmode="numeric" /></div>
        <div class="field"><label>–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞</label><input class="input" id="prOld" value="${escapeHtml(p?.oldPrice||"")}" inputmode="numeric" /></div>
      </div>
      <div class="field"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input class="input" id="prDesc" value="${escapeHtml(p?.desc||"")}" /></div>
      <div class="field"><label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL) –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞</label>
        <input class="input" id="prMedia" value="${escapeHtml(p?.media?.src||"")}" placeholder="https://..." />
        <input type="file" id="prFile" accept="image/*" />
        <div class="hint">–ó–∞–≥—Ä—É–∑–∫–∞ ‚Äî base64 –≤ LocalStorage (–¥–µ–º–æ).</div>
      </div>
      <div class="split">
        <div class="field"><label>–†–∞–∑–º–µ—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input class="input" id="prSizes" value="${escapeHtml(sizes)}" placeholder="S, M, L" /></div>
        <div class="field"><label>–¶–≤–µ—Ç–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input class="input" id="prColors" value="${escapeHtml(colors)}" placeholder="Black, Grey" /></div>
      </div>
      <div class="row">
        <button class="btn ghost small" id="cancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn small" id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    `;
  }

  function wireStoryForm(editId){
    const cancel = modalBody.querySelector("#cancel");
    const save = modalBody.querySelector("#save");
    cancel.onclick = ()=>openEditor();

    const file = modalBody.querySelector("#stFile");
    file.onchange = async ()=>{
      const f = file.files?.[0];
      if(!f) return;
      const b64 = await fileToDataUrl(f);
      modalBody.querySelector("#stMedia").value = b64;
      toast("–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω (–¥–µ–º–æ)");
    };

    save.onclick = ()=>{
      const title = modalBody.querySelector("#stTitle").value.trim();
      const media = modalBody.querySelector("#stMedia").value.trim();
      const ctaType = modalBody.querySelector("#stCtaType").value;
      const ctaLabel = modalBody.querySelector("#stCtaLabel").value.trim();
      const ctaTarget = modalBody.querySelector("#stCtaTarget").value.trim();
      if(!title || !media){ toast("–ó–∞–ø–æ–ª–Ω–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –º–µ–¥–∏–∞"); return; }
      const story = {
        id: editId || ("s_" + Math.random().toString(16).slice(2,8)),
        title,
        media: {type:"img", src: media},
        cta: { type: ctaType, targetId: ctaTarget, label: ctaLabel }
      };
      if(editId){
        state.stories = state.stories.map(x=>x.id===editId ? story : x);
      }else{
        state.stories.push(story);
      }
      saveState(); toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
      openEditor();
    };
  }

  function wireFeedForm(editId){
    const cancel = modalBody.querySelector("#cancel");
    const save = modalBody.querySelector("#save");
    cancel.onclick = ()=>openEditor();
    save.onclick = ()=>{
      const type = modalBody.querySelector("#fdType").value;
      const tag = modalBody.querySelector("#fdTag").value.trim();
      const title = modalBody.querySelector("#fdTitle").value.trim();
      const text = modalBody.querySelector("#fdText").value.trim();
      const media = modalBody.querySelector("#fdMedia").value.trim();
      const productId = modalBody.querySelector("#fdProd").value.trim();
      if(!title){ toast("–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"); return; }
      const post = {
        id: editId || ("f_" + Math.random().toString(16).slice(2,8)),
        type, tag, title, text,
        media: media ? {type:"img", src: media} : null,
        productId: productId || ""
      };
      if(editId) state.feed = state.feed.map(x=>x.id===editId ? post : x);
      else state.feed.unshift(post);
      // –¥–æ–±–∞–≤–∏–º –Ω–æ–≤—ã–π —Ç–µ–≥ –≤ —Ç–∞–±—ã –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      if(tag && !state.config.homeTabs.includes(tag)) state.config.homeTabs.push(tag);
      saveState(); toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
      openEditor();
    };
  }

  function wireReelForm(editId){
    const cancel = modalBody.querySelector("#cancel");
    const save = modalBody.querySelector("#save");
    cancel.onclick = ()=>openEditor();
    save.onclick = ()=>{
      const title = modalBody.querySelector("#rlTitle").value.trim();
      const media = modalBody.querySelector("#rlMedia").value.trim();
      const ids = modalBody.querySelector("#rlProdIds").value.split(",").map(s=>s.trim()).filter(Boolean);
      if(!title || !media){ toast("–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –≤–∏–¥–µ–æ URL –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã"); return; }
      const reel = {
        id: editId || ("r_" + Math.random().toString(16).slice(2,8)),
        title,
        media: {type:"video", src: media},
        productIds: ids
      };
      if(editId) state.reels = state.reels.map(x=>x.id===editId ? reel : x);
      else state.reels.push(reel);
      saveState(); toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
      openEditor();
    };
  }

  function wireProductForm(editId){
    const cancel = modalBody.querySelector("#cancel");
    const save = modalBody.querySelector("#save");
    cancel.onclick = ()=>openEditor();

    const file = modalBody.querySelector("#prFile");
    file.onchange = async ()=>{
      const f = file.files?.[0];
      if(!f) return;
      const b64 = await fileToDataUrl(f);
      modalBody.querySelector("#prMedia").value = b64;
      toast("–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω (–¥–µ–º–æ)");
    };

    save.onclick = ()=>{
      const title = modalBody.querySelector("#prTitle").value.trim();
      const price = Number(modalBody.querySelector("#prPrice").value);
      const oldPrice = Number(modalBody.querySelector("#prOld").value) || 0;
      const desc = modalBody.querySelector("#prDesc").value.trim();
      const media = modalBody.querySelector("#prMedia").value.trim();
      const sizes = modalBody.querySelector("#prSizes").value.split(",").map(s=>s.trim()).filter(Boolean);
      const colors = modalBody.querySelector("#prColors").value.split(",").map(s=>s.trim()).filter(Boolean);
      if(!title || !price || !media){ toast("–ù–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω–∞ –∏ –º–µ–¥–∏–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã"); return; }

      const prod = {
        id: editId || ("p_" + Math.random().toString(16).slice(2,8)),
        title,
        price,
        oldPrice,
        desc,
        media: {type:"img", src: media},
        variants: { sizes, colors }
      };

      if(editId) state.products = state.products.map(x=>x.id===editId ? prod : x);
      else state.products.unshift(prod);

      saveState(); toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
      openEditor();
    };
  }

  async function fileToDataUrl(file){
    return new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = ()=>res(String(r.result));
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  // Publish / Reset
  modalBody.querySelector("#publish").onclick = ()=>{
    // Save vitrina fields if present
    const bt = modalBody.querySelector("#eBrandTitle");
    if(bt){
      state.config.brandTitle = bt.value.trim() || state.config.brandTitle;
      state.config.brandTagline = modalBody.querySelector("#eBrandTagline").value.trim();
      state.config.theme.bg = modalBody.querySelector("#eBg").value.trim() || state.config.theme.bg;
      state.config.theme.text = modalBody.querySelector("#eText").value.trim() || state.config.theme.text;
      state.config.theme.muted = modalBody.querySelector("#eMuted").value.trim() || state.config.theme.muted;
      state.config.theme.accent = modalBody.querySelector("#eAccent").value.trim() || state.config.theme.accent;

      state.config.blocks.stories = modalBody.querySelector("#eStories").value==="true";
      state.config.blocks.feed = modalBody.querySelector("#eFeed").value==="true";
      state.config.blocks.reels = modalBody.querySelector("#eReels").value==="true";
      state.config.blocks.catalog = modalBody.querySelector("#eCatalog").value==="true";

      const tabs = modalBody.querySelector("#eTabs").value.split(",").map(s=>s.trim()).filter(Boolean);
      state.config.homeTabs = tabs.length ? tabs : ["–í—Å–µ"];
    }

    const pol = modalBody.querySelector("#ePolicy");
    if(pol){
      state.config.policyText = pol.value;
      state.config.legalText = modalBody.querySelector("#eLegal").value;
    }

    const pin = modalBody.querySelector("#ePin");
    if(pin){
      state.admin.pin = pin.value.trim() || state.admin.pin;
    }

    saveState();
    applyTheme();
    renderTabs();
    renderStories();
    renderView();
    toast("–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ");
  };

  modalBody.querySelector("#reset").onclick = ()=>{
    if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë –¥–æ –∑–∞–≤–æ–¥—Å–∫–∏—Ö –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö?")) return;
    localStorage.removeItem(LS_KEY);
    state = loadState();
    applyTheme();
    updateCartBadge();
    renderTabs();
    renderStories();
    renderView();
    toast("–°–±—Ä–æ—à–µ–Ω–æ");
    closeModal();
  };

  renderEditor();
}

/** ===============================
 *  Stories Viewer (Instagram-like MVP)
 *  =============================== */
let storyTimer = null;

function openStoryViewer(storyId){
  const idx0 = state.stories.findIndex(s=>s.id===storyId);
  if(idx0 < 0) return;

  let idx = idx0;
  let progress = 0; // 0..100
  const DURATION_MS = 4500; // –≤—Ä–µ–º—è –Ω–∞ –æ–¥–Ω—É —Å—Ç–æ—Ä–∏—Å
  const TICK_MS = 45;

  function render(){
    const s = state.stories[idx];
    if(!s) return;

    const ctaLabel = s.cta?.label?.trim() || "";
    const hasCta = !!ctaLabel;

    openModal("Stories", `
      <div style="position:relative;">
        <!-- progress -->
        <div style="display:flex; gap:6px; margin-bottom:10px;">
          ${state.stories.map((_,i)=>`
            <div style="flex:1; height:3px; border-radius:99px; background: rgba(255,255,255,.18); overflow:hidden;">
              <div style="
                height:100%;
                width:${i<idx?100:(i>idx?0:progress)}%;
                background: var(--text);
                opacity:${i===idx?0.9:0.5};
                transition: width ${TICK_MS}ms linear;
              "></div>
            </div>
          `).join("")}
        </div>

        <!-- media -->
        <div class="media" style="margin-bottom:10px">
          ${
            s.media.type==="img"
              ? `<img src="${s.media.src}" alt="">`
              : `<video src="${s.media.src}" autoplay muted playsinline></video>`
          }
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div style="font-weight:900">${escapeHtml(s.title||"")}</div>
          <div class="hint">${idx+1}/${state.stories.length}</div>
        </div>

        ${hasCta ? `
          <div style="margin-top:10px; display:flex; justify-content:flex-end;">
            <button class="btn small" id="storyCta">${escapeHtml(ctaLabel)}</button>
          </div>
        ` : ``}

        <!-- tap zones (prev/next like insta) -->
        <div id="tapPrev" style="position:absolute; left:0; top:0; bottom:0; width:35%;"></div>
        <div id="tapNext" style="position:absolute; right:0; top:0; bottom:0; width:65%;"></div>
      </div>
    `);

    // CTA logic
    const ctaBtn = modalBody.querySelector("#storyCta");
    if(ctaBtn){
      ctaBtn.onclick = ()=>{
        const cta = s.cta || {};
        closeModal();
        if(cta.type==="product" && cta.targetId){
          openProduct(cta.targetId);
        } else {
          setNav("catalog");
        }
      };
    }

    // Prev/Next zones
    modalBody.querySelector("#tapPrev").onclick = ()=>prev();
    modalBody.querySelector("#tapNext").onclick = ()=>next();

    // keyboard support (desktop)
    window.onkeydown = (e)=>{
      if(!overlay.classList.contains("show")) return;
      if(e.key==="ArrowLeft") prev();
      if(e.key==="ArrowRight") next();
      if(e.key==="Escape") { stop(); closeModal(); }
    };
  }

  function stop(){
    if(storyTimer) clearInterval(storyTimer);
    storyTimer = null;
  }

  function startTimer(){
    stop();
    progress = 0;
    storyTimer = setInterval(()=>{
      progress += (100 / (DURATION_MS / TICK_MS));
      if(progress >= 100){
        next();
      }else{
        // –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª–æ—Å–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ—Ä–µ–Ω–¥–µ—Ä–∞:
        // –ø—Ä–æ—â–µ –≤ MVP ‚Äî –¥–µ–ª–∞–µ–º –ª—ë–≥–∫–∏–π —Ä–µ—Ä–µ–Ω–¥–µ—Ä
        render();
      }
    }, TICK_MS);
  }

  function next(){
    stop();
    if(idx < state.stories.length - 1){
      idx++;
      progress = 0;
      render();
      startTimer();
    }else{
      closeModal();
    }
  }

  function prev(){
    stop();
    if(idx > 0){
      idx--;
      progress = 0;
      render();
      startTimer();
    }else{
      // –µ—Å–ª–∏ –ø–µ—Ä–≤–∞—è ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º
      closeModal();
    }
  }

  // –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞: –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ –∏–ª–∏ –≤—ã—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî —Å—Ç–æ–ø–∞–µ–º —Ç–∞–π–º–µ—Ä
  function cleanup(){
    stop();
    window.onkeydown = null;
    overlay.removeEventListener("click", onOverlayClick);
    document.removeEventListener("keydown", onEsc);
    window.removeEventListener("beforeunload", cleanup);
  }

  function onOverlayClick(e){
    // overlay –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É –≤ —Ç–≤–æ—ë–º –∫–æ–¥–µ, –ø–æ—ç—Ç–æ–º—É —Ç—É—Ç –ø—Ä–æ—Å—Ç–æ –ª–æ–≤–∏–º —Ñ–∞–∫—Ç –∫–ª–∏–∫–∞
    if(e.target === overlay) cleanup();
  }

  function onEsc(e){
    if(e.key === "Escape") cleanup();
  }

  overlay.addEventListener("click", onOverlayClick);
  document.addEventListener("keydown", onEsc);
  window.addEventListener("beforeunload", cleanup);
  render();
  startTimer();
}

/** ===============================
 *  Init
 *  =============================== */
renderTabs();
renderStories();
renderView();
</script>
</body>
</html>
